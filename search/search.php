<?php

$data = array(
    array(
        'type' => 'page',
        'category' => 'member_pages',
        'title' => 'Pension pay dates and direct deposit',
        'description' => 'This page provides you with the latest PSPP pay schedule',
        'breadcrums' => array('Home', 'Retired members', 'Welcome to retirement'),
        'date' => '2023-02-16 10:18:50',
        'image' => ''
    ),
    array(
        'type' => 'page',
        'category' => 'current_pages',
        'title' => 'Overview',
        'description' => "Whether you're a retired member or a surviving spouse/beneficiary, there's some critical information you need to know about your pension benefits.",
        'breadcrums' => array('Home', 'Retired members', 'Welcome to retirement'),
        'date' => '2023-02-16 10:18:50',
        'image' => '',
    ),
    array(
        'type' => 'page',
        'title' => 'Retirement administration',
        'category' => 'retired_members',
        'description' => 'Overview of the mechanics related to pension payments; i.e., pension formula, payment dates, CPP integration',
        'breadcrums' => array('Home', 'Retired members', 'Welcome to retirement'),
        'date' => '2023-02-16 10:18:50',
        'image' => ''
    ),
    array(
        'type' => 'articles',
        'category' => 'news',
        'title' => 'Cost-of-living increases for Retired Members',
        'description' => '',
        'date' => '2023-02-16 10:18:50',
        'image' => '../assets0215/img/img_search_01.jpg'
    ),
    array(
        'type' => 'articles',
        'category' => 'news',
        'title' => 'Pensions to increase by 1.6 per cent for 2018 cost-of-living adjustment',
        'description' => '',
        'date' => '2023-02-18 10:18:50',
        'image' => '../assets0215/img/img_search_03.jpg'
    ),
    array(
        'type' => 'articles',
        'category' => 'letter',
        'title' => 'Your 2023 cost-of-living adjustment',
        'description' => '',
        'date' => '2023-02-15 10:18:50',
        'image' => '../assets0215/img/img_search_02.jpg'
    ),
    array(
        'type' => 'articles',
        'category' => 'blog',
        'title' => 'Pensions to increase by 1.3 percent for 2017 cost-of-living-adjustment',
        'description' => '',
        'date' => '2023-02-19 10:18:50',
        'image' => '../assets0215/img/img_search_04.jpg'
    ),
    array(
        'type' => 'articles',
        'category' => 'letter',
        'title' => 'Pensions to increase by 2.2% on Jan 1, 2019',
        'description' => '',
        'date' => '2023-02-13 10:18:50',
        'image' => '../assets0215/img/img_search_05.jpg'
    ),
    array(
        'type' => 'forms',
        'category' => 'opb',
        'name' => 'OPB Form',
        'code' => 'OPB1043',
        'title' => 'Application to Purchase Pension Credit',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ),
    array(
        'type' => 'forms',
        'category' => 'fsco',
        'name' => 'FSCO / FSRA Waivers Form',
        'code' => 'FSCO-3',
        'title' => 'Waiver of Joint and Survivor Pension',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ),
    array(
        'type' => 'forms',
        'category' => 'fsra',
        'name' => 'FSRA Family Law Form',
        'code' => 'FL-1',
        'title' => 'Application for Family Law Value',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ),
    array(
        'type' => 'forms',
        'category' => 'cowan',
        'name' => 'Cowan Form',
        'code' => 'Cowan-1',
        'title' => 'Consent to Medical/Physical Information for Disability Pension (PDF)',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ),
    array(
        'type' => 'forms',
        'category' => 'canada',
        'name' => 'Canada Life Form',
        'code' => 'M445D',
        'title' => 'Dental Benefits Claim for Legacy Plan: Premium Free (plan #157836)',
        'date' => '2023-02-13 10:18:50',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ),
    array(
        'type' => 'publications',
        'category' => 'booklet',
        'name' => 'Booklets',
        'title' => 'CPP Integration and your PSPP pension',
        'publish' => '2023',
        'date' => '2023-02-13 10:18:51',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ),
    array(
        'type' => 'publications',
        'category' => 'booklet',
        'name' => 'Booklets',
        'title' => 'Understanding Your Pension Credit',
        'publish' => '2023',
        'date' => '2023-02-13 10:18:52',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ),
    array(
        'type' => 'publications',
        'category' => 'flyer',
        'name' => 'Flyers and Brochures',
        'title' => 'Expert Commission on Pensions Submission',
        'publish' => '2023',
        'date' => '2023-02-13 10:18:53',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ), array(
        'type' => 'publications',
        'category' => 'flyer',
        'name' => 'Flyers and Brochures',
        'title' => 'Survivor pensions for a new spouse - for retired members',
        'publish' => '2023',
        'date' => '2023-02-13 10:18:54',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ), array(
        'type' => 'publications',
        'category' => 'flyer',
        'name' => 'Flyers and Brochures',
        'title' => 'Dividing pensions, the old rules',
        'publish' => '2023',
        'date' => '2023-02-13 10:18:55',
        'link' => 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'
    ),
);

function getAll($page, $limit, $searchData)
{
    global $data;
    $dataFilter = $data;
    if (!empty($searchData)) {
        $dataFilter = array_filter($data, function ($var) use ($searchData) {
            return (strpos(strtolower($var['title']), strtolower($searchData)) !== false);
        });
    }
    $responseData = array_slice($dataFilter, ($page - 1) * $limit, $limit);
    return $responseData;
}

function comparator($object1, $object2)
{
    return $object1->date > $object2->date;
}

function getByType($page, $limit, $searchData, $type, $category, $sort)
{
    global $data;
    $dataFilter = $data;
    $dataFilter = array_filter($data, function ($var) use ($type) {
        return (strpos(strtolower($var['type']), strtolower($type)) !== false);
    });
    if ($type == 'articles' && !$sort || $type == 'publications' && !$sort) {
        $sort = 'desc';
    }
    if ($sort == 'desc') {
        if ($type == 'articles' || $type == 'publications') {
            usort($dataFilter, function ($a, $b) {
                return strtotime($b['date']) - strtotime($a['date']);
            });
        } else {
            usort($dataFilter, function ($a, $b) {
                return $b['title'] > $a['title'];
            });
        }
    } else if ($sort && $sort == 'asc') {
        if ($type == 'articles' || $type == 'publications') {
            usort($dataFilter, function ($a, $b) {
                return strtotime($a['date']) - strtotime($b['date']);
            });
        } else {
            usort($dataFilter, function ($a, $b) {
                return $a['title'] > $b['title'];
            });
        }
    }
    if ($category !== '') {
        $dataFilter = array_filter($dataFilter, function ($var) use ($category) {
            return (strpos(strtolower($var['category']), strtolower($category)) !== false);
        });
    }
    if ($searchData && !empty($searchData)) {
        $dataFilter = array_filter($dataFilter, function ($var) use ($searchData) {
            return (strpos(strtolower($var['title']), strtolower($searchData)) !== false);
        });
    }
    $responseData = array_slice($dataFilter, ($page - 1) * $limit, $limit);
    return $responseData;
}

function getTotal()
{
    global $data;
    $result = array();
    foreach ($data as $element) {
        if (!isset($result[$element['type']])) {
            $result[$element['type']] = 0;
        }
        $result[$element['type']]++;
    }
    $result['all'] = count($data);
    return $result;
}
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest') {
        header('Content-Type: application/json');
        if (isset($_POST['action'])) {
            $action = $_POST['action'];
            switch ($action) {
                case 'getAll':
                    $page = $_POST['page'];
                    $limit = $_POST['limit'];
                    $searchData = $_POST['searchData'];
                    $result = getAll($page, $limit, $searchData);
                    echo json_encode(array('data' => $result));
                    break;
                case 'getTotal':
                    $result = getTotal();
                    echo json_encode(array('data' => $result));
                    break;
                case 'getByType':
                    $page = $_POST['page'];
                    $limit = $_POST['limit'];
                    $searchData = $_POST['searchData'];
                    $category = $_POST['category'];
                    $type = $_POST['type'];
                    $sort = $_POST['sort'];
                    $result = getByType($page, $limit, $searchData, $type, $category, $sort);
                    echo json_encode(array('data' => $result));
                    break;
                default:
                    header("HTTP/1.0 404 Not Found");
                    exit;
            }
        } else {
            header("HTTP/1.0 400 Bad Request");
            exit;
        }
        exit;
    }
}
